# .github/workflows/deploy.yml

name: Build with Bazel, Deploy with Fastlane

# Trigger this workflow on every push to the 'main' branch
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy to TestFlight
    runs-on: macos-latest

    steps:
      # 1. Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Cache Bazel build artifacts
      # This is a critical performance improvement. It saves the Bazel cache 
      # between runs, so you don't have to redownload dependencies every time.
      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: ~/.cache/bazel
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/MODULE.bazel', '**/WORKSPACE', '.bazelversion') }}
          restore-keys: |
            ${{ runner.os }}-bazel-

      # 3. Select the version of Xcode to use
      # Required by Bazel's iOS build rules.
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 4. Clean Bazel cache to avoid stale dependencies
      - name: Clean Bazel cache
        run: bazel clean --expunge

      # 5. Build IPA with Bazel
      # The 'Install Bazel' step has been removed. The GitHub runner has 'bazelisk'
      # pre-installed, which will read the .bazelversion file and automatically
      # use the correct version of Bazel for the build.
      - name: Build IPA with Bazel
        run: |
          bazel build //CrossSumsSimple:CrossSumsSimple_ipa --config=ios_release --verbose_failures

      # 6. Setup Ruby and Fastlane
      # This installs Ruby and your project's gems (like fastlane) from the Gemfile.
      # The `bundler-cache: true` option enables caching for gems, speeding up runs.
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ./fastlane # Specifies where to find the Gemfile

      # 7. Run Fastlane to Deploy
      # This step runs inside the `./fastlane` directory.
      - name: Upload to TestFlight
        working-directory: ./fastlane
        env:
          # Secrets for authenticating with App Store Connect
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
          
          # Pass the correct relative path to the IPA. Since this step runs inside
          # the `./fastlane` directory, we use `../` to go up one level.
          # Your Fastfile should use `ENV['FASTLANE_IPA_PATH']` to get this value.
          FASTLANE_IPA_PATH: ../bazel-bin/CrossSumsSimple/CrossSumsSimple_ipa.ipa
        run: bundle exec fastlane beta
